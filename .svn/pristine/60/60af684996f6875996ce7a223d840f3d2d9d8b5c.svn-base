/*! caps 23-10-2014 */
function render(){ball.position.y<=-50&&(scene.remove(ball),create_caps()),ball.position.z<=-100&&create_caps(),bottlecaps.position.y<=bottle.position.y&&create_bottlecaps(),camera.lookAt(lookatobj.position),renderer.render(scene,camera),requestAnimationFrame(render)}function create_caps(){ball=new Physijs.CylinderMesh(caps_geometry,caps_material,.5);var a={x:Math.PI,y:0,z:0},b=new THREE.Vector3(0,0,0);ball.rotation.set(a.x,a.y,a.z),ball.position.y=60,ball.position.z=80,ball.castShadow=!0,ball.receiveShadow=!0,ball.setAngularFactor(b),ball.setLinearFactor(b),ball.setLinearVelocity(b),ball.setAngularVelocity(b),scene.add(ball),elements.push(ball)}function create_bottlecaps(){bottlecaps=new Physijs.CylinderMesh(caps_geometry,bottlecaps_material,.3),bottlecaps.position.y=bottle.position.y+16,bottlecaps.position.x=bottle.position.x,bottlecaps.position.z=bottle.position.z,bottlecaps.castShadow=!0,bottlecaps.receiveShadow=!0,scene.add(bottlecaps),elements.push(bottlecaps)}function create_bottle(a){bottle=new Physijs.CylinderMesh(new THREE.CylinderGeometry(5,7,30,32),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:16777215}),.4,.8),20),bottle.position.y=16,bottle.position.x=a,bottle.position.z=-80,bottle.castShadow=!0,bottle.receiveShadow=!0,scene.add(bottle),create_bottlecaps()}function buildAxes(a){var b=new THREE.Object3D;return b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(a,0,0),16711680,!1)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(-a,0,0),16711680,!0)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,a,0),65280,!1)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,-a,0),65280,!0)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,a),255,!1)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,-a),255,!0)),b}function buildAxis(a,b,c,d){var e,f=new THREE.Geometry;e=d?new THREE.LineDashedMaterial({linewidth:3,color:c,dashSize:3,gapSize:3}):new THREE.LineBasicMaterial({linewidth:3,color:c}),f.vertices.push(a.clone()),f.vertices.push(b.clone()),f.computeLineDistances();var g=new THREE.Line(f,e,THREE.LinePieces);return g}var container,scene,renderer,camera,light,ball,plane,bottle,bottlecaps,axes,initEventHandling,initScene,WIDTH,HEIGHT,VIEW_ANGLE,ASPECT,NEAR,FAR,elements=[],selected_block=null,mouse_position=new THREE.Vector3,block_offset=new THREE.Vector3,_i,_v3=new THREE.Vector3,intersect_plane,lookatobj,clock=new THREE.Clock;Physijs.scripts.worker="/js/physijs/physijs_worker.js",Physijs.scripts.ammo="ammo.js",container=document.querySelector(".viewport"),WIDTH=window.innerWidth,HEIGHT=window.innerHeight,VIEW_ANGLE=75,ASPECT=WIDTH/HEIGHT,NEAR=.1,FAR=1e4;var caps_geometry=new THREE.CylinderGeometry(7,5,2,32),caps_material=Physijs.createMaterial(new THREE.MeshLambertMaterial({color:16711680}),.4,.8),bottlecaps_material=Physijs.createMaterial(new THREE.MeshLambertMaterial({color:65280}),.4,.8);initScene=function(){scene=new Physijs.Scene,scene.setGravity(new THREE.Vector3(0,-110,0)),scene.addEventListener("update",function(){if(null!==selected_block)for(_v3.copy(mouse_position).add(block_offset).sub(selected_block.position).multiplyScalar(5),_v3.y=0,selected_block.setLinearVelocity(_v3),_v3.set(0,0,0),_i=0;_i<elements.length;_i++)elements[_i].applyCentralImpulse(_v3);scene.simulate(void 0,2)}),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setSize(WIDTH,HEIGHT),renderer.shadowMapEnabled=!0,renderer.shadowMapSoft=!0,renderer.shadowMapType=THREE.PCFShadowMap,renderer.shadowMapAutoUpdate=!0,container.appendChild(renderer.domElement),camera=new THREE.PerspectiveCamera(VIEW_ANGLE,ASPECT,NEAR,FAR),camera.position.set(10,70,150),lookatobj=scene,camera.lookAt(lookatobj),scene.add(camera),light=new THREE.DirectionalLight(16777215),light.position.set(0,100,60),light.castShadow=!0,light.shadowCameraLeft=-60,light.shadowCameraTop=-60,light.shadowCameraRight=60,light.shadowCameraBottom=60,light.shadowCameraNear=1,light.shadowCameraFar=1e3,light.shadowBias=-1e-4,light.shadowMapWidth=light.shadowMapHeight=1024,light.shadowDarkness=.7,scene.add(light),plane=new Physijs.BoxMesh(new THREE.BoxGeometry(WIDTH,HEIGHT,2,100,100),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:15658734,transparent:!0,opacity:.5}),.4,.8),0),plane.rotation.x=Math.PI/2,plane.receiveShadow=!0,scene.add(plane),intersect_plane=new THREE.Mesh(new THREE.PlaneGeometry(WIDTH,HEIGHT),new THREE.MeshBasicMaterial({opacity:0,transparent:!0})),intersect_plane.rotation.x=Math.PI/-2,scene.add(intersect_plane),axes=buildAxes(1e3),scene.add(axes),create_bottle(0),create_bottle(60),create_bottle(-60),create_caps(),scene.simulate(),render(),initEventHandling()},document.addEventListener("keydown",function(a){switch(console.log(a.keyCode),a.keyCode){case 37:camera.position.x-=1;break;case 39:camera.position.x+=1;break;case 38:camera.position.y+=1;break;case 40:camera.position.y-=1;break;case 32:create_caps();break;case 67:lookatobj=ball;break;case 86:lookatobj=bottlecaps;break;case 66:lookatobj=scene}}),document.addEventListener("scroll",function(a){switch(a.keyCode){case 37:camera.position.x-=1;break;case 39:camera.position.x+=1;break;case 38:camera.position.y+=1;break;case 40:camera.position.y-=1;break;case 32:create_caps()}}),initEventHandling=function(){var a,b,c,d=new THREE.Vector3,e=new THREE.Projector;return a=function(a){var b,c;d.set(a.clientX/window.innerWidth*2-1,2*-(a.clientY/window.innerHeight)+1,2*-(a.clientX/a.clientY)+1),e.unprojectVector(d,camera),b=new THREE.Raycaster(camera.position,d.sub(camera.position).normalize()),c=b.intersectObjects(elements),c.length>0&&(selected_block=c[0].object,d.set(0,0,0),selected_block.setAngularFactor(d),selected_block.setAngularVelocity(d),selected_block.setLinearFactor(d),selected_block.setLinearVelocity(d),mouse_position.copy(c[0].point),block_offset.subVectors(selected_block.position,mouse_position),intersect_plane.position.y=mouse_position.y)},b=function(a){var b,c;null!==selected_block&&(d.set(a.clientX/window.innerWidth*2-1,2*-(a.clientY/window.innerHeight)+1,1),e.unprojectVector(d,camera),b=new THREE.Raycaster(camera.position,d.sub(camera.position).normalize()),c=b.intersectObject(intersect_plane),mouse_position.copy(c[0].point))},c=function(){null!==selected_block&&(d.set(1,1,1),selected_block.setAngularFactor(d),selected_block.setLinearFactor(d),selected_block=null)},function(){renderer.domElement.addEventListener("mousedown",a),renderer.domElement.addEventListener("mousemove",b),renderer.domElement.addEventListener("mouseup",c)}}(),initScene();