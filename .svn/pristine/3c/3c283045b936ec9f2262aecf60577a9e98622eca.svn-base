/*! caps 26-11-2014 */
function loadBottleTools(){var a=new THREE.JSONLoader;a.load("model/chimey/chimey.json",function(b,c){a.load("model/sticker/sticker.json",function(a){sticker_geo=a}),a.load("model/bottle/bottle_chimey.json",function(a,d){bottle_geo=a;var e=d[0];e.side=2,e.map.anisotropy=0,e.shininess=0,e.shading=0,e.reflectivity=0,e.ambient.setHex(16777215),e.color.setHex(16777215),bottle_mat=new THREE.MeshFaceMaterial(d),geo_caps=b;var f=c[0];f.side=2,f.map.anisotropy=0,mat_caps=new THREE.MeshFaceMaterial(c),initScene()})})}function render(){(Viensla.bottlecaps.position.y<=Viensla.bottle.position.y||Viensla.bottlecaps.position.y>Viensla.bottle.position.y+20||Viensla.bottlecaps.position.x>Viensla.bottle.position.x+5||Viensla.bottlecaps.position.x<Viensla.bottle.position.x-5||Viensla.bottlecaps.position.z>Viensla.bottle.position.z+5||Viensla.bottlecaps.position.z<Viensla.bottle.position.z-5)&&Viensla.bottlecaps.collided&&(Viensla.bottlecaps.collided=!1,Party.plcaps()),(Player.bottlecaps.position.y<=Player.bottle.position.y||Player.bottlecaps.position.y>Player.bottle.position.y+20||Player.bottlecaps.position.x>Player.bottle.position.x+5||Player.bottlecaps.position.x<Player.bottle.position.x-5||Player.bottlecaps.position.z>Player.bottle.position.z+5||Player.bottlecaps.position.z<Player.bottle.position.z-5)&&Player.bottlecaps.collided&&(Player.bottlecaps.collided=!1,Party.vlcaps()),camera.lookAt(lookatobj.position),spotCreator.draw();var a=5e-4*Date.now();pointLight.position.x=3e3*Math.sin(a),pointLight.position.y=600,pointLight.position.z=3e3*Math.cos(a),renderer.render(scene,camera),requestAnimationFrame(render)}function onWindowResize(){renderer.setSize(window.innerWidth,window.innerHeight),camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix()}function create_camera(){playerCamera=new THREE.PerspectiveCamera(VIEW_ANGLE,ASPECT,NEAR,FAR),playerCamera.position.set(playerCamPos.x,playerCamPos.y,playerCamPos.z),playerCamera.lookAt(scene),scene.add(playerCamera),vlCamera=new THREE.PerspectiveCamera(VIEW_ANGLE,ASPECT,NEAR,FAR),vlCamera.position.set(vlCamPos.x,vlCamPos.y,vlCamPos.z),vlCamera.lookAt(scene),scene.add(vlCamera),camera=playerCamera,camera.initialpos=playerCamPos,mouse={x:0,y:0},document.addEventListener("mousemove",function(a){mouse.x=a.clientX/window.innerWidth-.5,mouse.y=a.clientY/window.innerHeight-.5,camera.position.x+=1.5*(20*mouse.x-camera.position.x)+camera.initialpos.x,camera.position.y+=1.5*(10*mouse.y-camera.position.y)+camera.initialpos.y-10,camera.lookAt(lookatobj)},!1)}function change_camera(){camera==playerCamera?(camera=vlCamera,camera.initialpos=vlCamPos,lookatobj=Player.bottle,globalDirection=-1):(camera=playerCamera,camera.initialpos=playerCamPos,lookatobj=Viensla.bottle,globalDirection=1)}function create_caps(a){var b=Math.random()>.8,c=b?4:2;"undefined"==typeof a&&(a="pl");var d=Physijs.createMaterial(new THREE.MeshLambertMaterial(mat_caps.materials));if(d.side=2,d.color.setHex(b?cred:cblue),mat_caps.side=2,ball=new Physijs.CylinderMesh(geo_caps,mat_caps,c,{friction:0,restitution:.8}),ball.scale.set(capModelscale,capModelscale,capModelscale),ball.collisions=0,ball.addEventListener("collision",capCollision),ball.position.y=50,ball.position.x=0,ball.position.z=playerDistance*globalDirection,ball.castShadow=!0,ball.receiveShadow=!0,scene.add(ball),elements.push(ball),playedCaps=ball,playedCaps.floating=!0,playedCaps.name="vl"==a?"viensla":"player",elements.length>10){var e=elements[0];scene.remove(e),elements.splice(0,1)}Sounds.mute||Sounds.pschit1.play()}function setPower(){power+=powerDir,power>100&&(powerDir=-speedbar),0>power&&(powerDir=+speedbar),$(".powerbar .bar").height(power+"%")}function capsm(){$("#caps-m").show(),setTimeout(function(){$("#caps-m").hide()},1e3),Sounds.mute||Sounds.pschit2.play()}function create_table(){level=new Physijs.BoxMesh(new THREE.BoxGeometry(5,1,.5),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:ptpgrey})),0),level.position.x=0,level.position.y=0,level.position.z=0,level.castShadow=!0,level.receiveShadow=!0,level.name="level",_floor=new Physijs.BoxMesh(new THREE.BoxGeometry(3e3,3e3,35),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:4078652})),0),_floor.rotation.x=Math.PI/2,_floor.position.x=0,_floor.position.y=-1,_floor.position.z=0,_floor.castShadow=!0,_floor.receiveShadow=!0,_floor.name="floor",scene.add(_floor),_tapis=new Physijs.BoxMesh(new THREE.BoxGeometry(planeWIDTH,planeHEIGHT,35),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:ptpyellow})),0),_tapis.rotation.x=Math.PI/2,_tapis.position.x=0,_tapis.position.y=0,_tapis.position.z=0,_tapis.castShadow=!0,_tapis.receiveShadow=!0,_tapis.name="tapis",scene.add(_tapis),_tablefoot=new Physijs.BoxMesh(new THREE.BoxGeometry(tablefootSurfaceDim[0],tablefootSurfaceDim[1],tablefootSurfaceDim[2]),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:cblue})),0),_tablefoot.position.x=0,_tablefoot.position.y=tablefootSurfaceDim[1]-2,_tablefoot.position.z=-90,_tablefoot.castShadow=!0,_tablefoot.receiveShadow=!0,level.add(_tablefoot),_tablefoot=new Physijs.BoxMesh(new THREE.BoxGeometry(tablefootSurfaceDim[0],tablefootSurfaceDim[1],tablefootSurfaceDim[2]),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:cgreen})),0),_tablefoot.position.x=0,_tablefoot.position.y=tablefootSurfaceDim[1],_tablefoot.position.z=90,_tablefoot.castShadow=!0,_tablefoot.receiveShadow=!0,level.add(_tablefoot),_table=new Physijs.BoxMesh(new THREE.BoxGeometry(tableSurfaceDim[0],tableSurfaceDim[1],tableSurfaceDim[2]),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:16777215})),0),_table.position.x=0,_table.position.y=tablefootSurfaceDim[1]+tablefootSurfaceDim[1]/2,_table.position.z=-90,_table.castShadow=!0,_table.receiveShadow=!0,level.add(_table),_table=new Physijs.BoxMesh(new THREE.BoxGeometry(tableSurfaceDim[0]+100,tableSurfaceDim[1],tableSurfaceDim[2]),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:16777215})),0),_table.position.x=0,_table.position.y=tablefootSurfaceDim[1]+tablefootSurfaceDim[1]/2,_table.position.z=90,_table.castShadow=!0,_table.receiveShadow=!0,level.add(_table),scene.add(level);var a=document.getElementById("vertexShader").textContent,b=document.getElementById("fragmentShader").textContent,c={topColor:{type:"c",value:new THREE.Color(5131340)},bottomColor:{type:"c",value:new THREE.Color(4078652)},offset:{type:"f",value:10},exponent:{type:"f",value:.6}};c.topColor.value.copy(hemiLight.color),scene.fog.color.copy(c.bottomColor.value);var d=new THREE.SphereGeometry(1e3,64,15),e=new THREE.ShaderMaterial({vertexShader:a,fragmentShader:b,uniforms:c,side:THREE.BackSide}),f=new THREE.Mesh(d,e);scene.add(f)}function buildAxes(a){var b=new THREE.Object3D;return b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(a,0,0),16711680,!1)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(-a,0,0),16711680,!0)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,a,0),65280,!1)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,-a,0),65280,!0)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,a),255,!1)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,-a),255,!0)),b}function buildAxis(a,b,c,d){var e,f=new THREE.Geometry;e=d?new THREE.LineDashedMaterial({linewidth:3,color:c,dashSize:3,gapSize:3}):new THREE.LineBasicMaterial({linewidth:3,color:c}),f.vertices.push(a.clone()),f.vertices.push(b.clone()),f.computeLineDistances();var g=new THREE.Line(f,e,THREE.LinePieces);return g}function create_lights(){frontLight.castShadow=!0,frontLight.shadowDarkness=.1,frontLight.shadowBias=-1e-4,frontLight.shadowCameraNear=1,frontLight.shadowMapWidth=2048,frontLight.shadowMapHeight=2048,frontLight.shadowCameraLeft=planeWIDTH/2,frontLight.shadowCameraTop=-planeHEIGHT/2,frontLight.shadowCameraRight=-planeWIDTH/2,frontLight.shadowCameraBottom=planeHEIGHT/2,frontLight.position.set(0,100,80),scene.add(frontLight),backLight.castShadow=!0,backLight.shadowDarkness=.1,backLight.shadowBias=-1e-4,backLight.shadowCameraNear=1,backLight.shadowMapWidth=2048,backLight.shadowMapHeight=2048,backLight.shadowCameraLeft=planeWIDTH/2,backLight.shadowCameraTop=-planeHEIGHT/2,backLight.shadowCameraRight=-planeWIDTH/2,backLight.shadowCameraBottom=planeHEIGHT/2,backLight.position.set(0,100,-80),scene.add(backLight),rightLight.castShadow=!0,rightLight.shadowDarkness=.05,rightLight.shadowBias=-1e-4,rightLight.shadowCameraNear=1,rightLight.shadowMapWidth=2048,rightLight.shadowMapHeight=2048,rightLight.shadowCameraLeft=planeWIDTH/2,rightLight.shadowCameraTop=-planeHEIGHT/2,rightLight.shadowCameraRight=-planeWIDTH/2,rightLight.shadowCameraBottom=planeHEIGHT/2,rightLight.position.set(80,40,30),leftLight.castShadow=!0,leftLight.shadowDarkness=.05,leftLight.shadowBias=-1e-4,leftLight.shadowCameraNear=1,leftLight.shadowMapWidth=2048,leftLight.shadowMapHeight=2048,leftLight.shadowCameraLeft=planeWIDTH/2,leftLight.shadowCameraTop=-planeHEIGHT/2,leftLight.shadowCameraRight=-planeWIDTH/2,leftLight.shadowCameraBottom=planeHEIGHT/2,leftLight.position.set(-100,70,-10),scene.add(ambientLight),scene.add(pointLight),hemiLight=new THREE.HemisphereLight(16777215,16777215,.8),hemiLight.color.setHSL(.7,.7,.9),hemiLight.groundColor.setHSL(.5,.5,.5),hemiLight.position.set(0,300,0),scene.add(hemiLight)}function addFloatingLights(){var a=new THREE.SphereGeometry(.5,16,8);light1=new THREE.PointLight(16711744,2,50),light1.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16711744}))),scene.add(light1),light2=new THREE.PointLight(16639,2,50),light2.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16639}))),scene.add(light2),light3=new THREE.PointLight(8454016,2,50),light3.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:8454016}))),scene.add(light3),light4=new THREE.PointLight(16755200,2,50),light4.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16755200}))),scene.add(light4),light5=new THREE.PointLight(16711744,2,50),light5.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16711744}))),scene.add(light5),light6=new THREE.PointLight(16639,2,50),light6.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16639}))),scene.add(light6),light7=new THREE.PointLight(8454016,2,50),light7.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:8454016}))),scene.add(light7),light8=new THREE.PointLight(16755200,2,50),light8.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16755200}))),scene.add(light8),light9=new THREE.PointLight(16711744,2,50),light9.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16711744}))),scene.add(light9),light10=new THREE.PointLight(16639,2,50),light10.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16639}))),scene.add(light10),light11=new THREE.PointLight(8454016,2,50),light11.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:8454016}))),scene.add(light11),light12=new THREE.PointLight(16755200,2,50),light12.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16755200}))),scene.add(light12)}function animateFloatingLights(a){light1.position.x=50*Math.sin(.7*a),light1.position.y=50*Math.cos(.5*a)+100,light1.position.z=50*Math.cos(.3*a),light2.position.x=50*Math.cos(.3*a),light2.position.y=50*Math.sin(.5*a)+100,light2.position.z=50*Math.sin(.7*a),light3.position.x=50*Math.sin(.7*a),light3.position.y=50*Math.cos(.3*a)+100,light3.position.z=50*Math.sin(.5*a),light4.position.x=50*Math.sin(.3*a),light4.position.y=50*Math.cos(.7*a)+100,light4.position.z=50*Math.sin(.5*a),light5.position.x=50*Math.sin(.3*a),light5.position.y=50*Math.cos(.7*a)+100,light5.position.z=50*Math.sin(.5*a),light6.position.x=50*Math.sin(.3*a),light6.position.y=50*Math.cos(.7*a)+100,light6.position.z=50*Math.sin(.5*a),light7.position.x=50*Math.sin(.3*a),light7.position.y=50*Math.cos(.7*a)+100,light7.position.z=50*Math.sin(.5*a),light8.position.x=50*Math.sin(.3*a),light8.position.y=50*Math.cos(.7*a)+100,light8.position.z=50*Math.sin(.5*a),light9.position.x=50*Math.sin(.3*a),light9.position.y=50*Math.cos(.7*a)+100,light9.position.z=50*Math.sin(.5*a),light10.position.x=50*Math.sin(.3*a),light10.position.y=50*Math.cos(.7*a)+100,light10.position.z=50*Math.sin(.5*a),light11.position.x=50*Math.sin(.3*a),light11.position.y=50*Math.cos(.7*a)+100,light11.position.z=50*Math.sin(.5*a),light12.position.x=50*Math.sin(.3*a),light12.position.y=50*Math.cos(.7*a)+100,light12.position.z=50*Math.sin(.5*a)}function createShaderMaterial(a,b){var c=THREE.ShaderTypes[a],d=THREE.UniformsUtils.clone(c.uniforms),e=c.vertexShader,f=c.fragmentShader,g=new THREE.ShaderMaterial({uniforms:d,vertexShader:e,fragmentShader:f});return g.uniforms.uDirLightPos.value=b.position,g.uniforms.uDirLightColor.value=b.color,g}var cblue=6793921,cyellow=16241731,cgreen=7908704,cred=12674922,ptpgrey=5854550,ptpyellow=16702506,container,scene,renderer,light,ball,plane,bottle,bottlecaps,axes,initEventHandling,initScene,WIDTH,HEIGHT,planeWIDTH,planeHEIGHT,elements=[],playedCaps=null,mouse_position=new THREE.Vector3,block_offset=new THREE.Vector3,_i,_v3=new THREE.Vector3,intersect_plane,lookatobj,pilone,mouse,mouse3D=new THREE.Vector3,_nullVector=new THREE.Vector3(0,0,0),DCMP=new THREE.Vector3(0,0,0),_natVector=new THREE.Vector3(1,1,1),onRenderFcts=[],lastTimeMsec=null,capsYpos=80,movingCaps=null,clock=new THREE.Clock,dir,distance,holdingDown=!1,discImg=THREE.ImageUtils.loadTexture("images/caps2.jpg"),discMat=new THREE.MeshLambertMaterial({map:discImg}),discParticules,discGeo=new THREE.Geometry;Physijs.scripts.worker="/js/physijs/physijs_worker.js",Physijs.scripts.ammo="ammo.js",container=document.querySelector(".viewport"),WIDTH=window.innerWidth,HEIGHT=window.innerHeight;var playerDistance=85,globalDirection=1,capsDae,capsMesh,capModelscale=1.6,geo_caps,mat_caps,bottle_geo,bottle_mat,$plpart,$vlpart,plscore=0,vlscore=0,texture,mat,sticker_geo,testPly={geo:"",mat:""},caps_geometry;caps_geometry=new THREE.CylinderGeometry(4,3,1.2,32);var caps_material=Physijs.createMaterial(new THREE.MeshLambertMaterial({color:cred}),.4,.8),bottlecaps_material=Physijs.createMaterial(new THREE.MeshLambertMaterial({color:cgreen}),.4,.8),initScene=function(){scene=new Physijs.Scene,scene.setGravity(new THREE.Vector3(0,-80,0)),scene.fog=new THREE.Fog(328965,2e3,3500),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setSize(WIDTH,HEIGHT),renderer.shadowMapEnabled=!0,renderer.shadowMapSoft=!0,renderer.shadowMapType=THREE.PCFShadowMap,renderer.shadowMapAutoUpdate=!0,renderer.gammaInput=!0,renderer.gammaOutput=!0,renderer.setClearColor(scene.fog.color,1),container.appendChild(renderer.domElement),create_camera(),create_lights(),create_table(),axes=buildAxes(1e3),axes.presence=!1,axes.traverse(function(a){a.visible=!1}),scene.add(axes),Viensla.initialize(),Player.initialize(),lookatobj=Viensla.bottle,scene.simulate(),initEventHandling(),spotCreator.create(),render(),scene.addEventListener("update",function(){playedCaps&&Player.isPlaying&&playedCaps.position.copy(DCMP),holdingDown&&setPower(),scene.simulate(void 0,2)})},discTopVector=new THREE.Vector3(1,20,1),spotCreator={obj:null,els:[],nbDisc:0,create:function(){discParticules=new THREE.PointCloud(discGeo,discMat)},draw:function(){if(this.obj){if(spotCreator.nbDisc>80)return spotCreator.obj=null,spotCreator.nbDisc=0,void(spotCreator.els=[]);var a=new Physijs.BoxMesh(new THREE.SphereGeometry(Math.random(),5,16),discMat);a.position.x=Viensla.bottle.position.x,a.position.y=Player.bottle.position.y+20,a.position.z=Viensla.bottle.position.z,discTopVector.set(10*Math.random(),40*Math.random(),10*Math.random()),setTimeout(function(){},5e3),a.setLinearVelocity(discTopVector),this.nbDisc++}}};$(document).ready(function(){$plpart=$(".pl-part"),$vlpart=$(".vl-part"),loadBottleTools(),window.addEventListener("resize",onWindowResize,!1),$("#party").click(function(){Party.create()}),$("#mute").click(function(){Sounds.mute=!Sounds.mute}),$plpart.find(".capsstock span").click(function(){Viensla.isPlaying||Party.plplay()})});var playerCamera,vlCamera,camera,playerCamPos=new THREE.Vector3(0,240,165),vlCamPos=new THREE.Vector3(0,190,-170),VIEW_ANGLE=75,ASPECT=WIDTH/HEIGHT,NEAR=.1,FAR=1e4;capCollision=function(a){var b=this;if(b.collisions++,!b.floating){var c=a.name;switch(c){case"level":Sounds.mute||Sounds.simpletap2.play();break;case"tapis":Sounds.mute||Sounds.simpletap1.play();break;case"floor":Sounds.mute||Sounds.simpletap3.play();break;case"vlCap":"player"==b.name&&(a.collided=!0),Sounds.mute||Sounds.capcap.play();break;case"plCap":"viensla"==b.name&&(a.collided=!0),Sounds.mute||Sounds.pschit1.play();break;case"vlBottle":Sounds.mute||Sounds.clink.play();break;case"plBottle":Sounds.mute||Sounds.pschit1.play();break;case"":console.log("Unamed hit !")}"vlCap"==c&&(a.__dirtyPosition=!0)}};var power=0,speedbar=2,powerDir=speedbar,strengh=6;initEventHandling=function(){var a,b,c,d=new THREE.Vector3,e=new THREE.Vector3,f=new THREE.Vector3;return a=function(){playedCaps&&(holdingDown=!0,d.set(1,-3,-100),power=0,$(".powerbar").fadeIn())},b=function(a){var b=a.clientX,c=a.clientY;$(".powerbar").css({left:b+50,top:c-50}),playedCaps&&(mouse3D.set(b/window.innerWidth*2-1,2*-(c/window.innerHeight)+1,1),mouse3D.unproject(camera),dir=mouse3D.sub(camera.position).normalize(),distance=-camera.position.z/dir.z,DCMP=camera.position.clone().add(dir.multiplyScalar(distance/2)),DCMP.z=playerDistance*globalDirection)},c=function(){playedCaps&&(holdingDown=!1,playedCaps.__dirtyPosition=!0,playedCaps.floating=!1,e.set(1,1,1),f.set(10*Math.random(),10*Math.random(),20*Math.random()),playedCaps.setAngularFactor(e),playedCaps.setLinearFactor(e),d.set(1,-3,-power*strengh*globalDirection),playedCaps.setLinearVelocity(d),playedCaps.setAngularVelocity(f),playedCaps.position.copy(DCMP),playedCaps=null,power=0,$(".powerbar").fadeOut(),Player.launched++,Player.totalLaunched++,Player.launched==Party.capsPerTurn&&setTimeout(function(){console.log("viens la attack"),Viensla.launched=0,Player.isPlaying=!1,Party.vlplay()},3e3))},function(){renderer.domElement.addEventListener("mousedown",a),renderer.domElement.addEventListener("mousemove",b),renderer.domElement.addEventListener("mouseup",c)}}();var timeoutRobot,Party={isPlaying:!1,capsPerTurn:3,lives:30,create:function(){this.isPlaying=!0,Viensla.score=Player.score=0,Viensla.lives=Player.lives=Party.lives,this.plplay(),this.setLife(),$("#party").fadeOut(),$(".capsstock").fadeIn()},vlplay:function(){this.isPlaying&&(Viensla.launched<Party.capsPerTurn&&!Player.isPlaying?($vlpart.find(".capsstock span").eq(Viensla.launched).hide(),Viensla.isPlaying=!0,Player.isPlaying=!1,Viensla.launchCaps(),timeoutRobot=setTimeout(function(){Party.vlplay()},4e3)):(clearTimeout(timeoutRobot),Player.isPlaying=!0,Player.launched=0,Viensla.isPlaying=!1,console.log("Viens la no more caps !"),this.resetStocks()))},plplay:function(){this.isPlaying&&(Player.launched<Party.capsPerTurn&&!Viensla.isPlaying?($plpart.find(".capsstock span").eq(Player.launched).hide(),clearTimeout(timeoutRobot),globalDirection=1,create_caps("pl"),Player.isPlaying=!0,Viensla.isPlaying=!1):(Player.isPlaying=!1,console.log("Player no more caps !"),Viensla.launched=0,Party.vlplay()))},vlcaps:function(){this.isPlaying&&(Viensla.score++,Player.lives-=Math.round(16-2*Viensla.launched),clearTimeout(timeoutRobot),Viensla.isPlaying=!1,capsm(),Party.resetStocks(),$vlpart.find(".score").text(Viensla.score),setTimeout(function(){Player.isPlaying=!0,Player.launched=0,Viensla.isPlaying=!1,Player.generateCaps(),Party.resetStocks()},1e3),Party.setLife())},plcaps:function(){this.isPlaying&&(Player.score++,Viensla.lives-=Math.round(16-2*Player.launched),Player.isPlaying=!1,capsm(),$plpart.find(".score").text(Player.score),Party.resetStocks(),setTimeout(function(){Viensla.generateCaps(),Party.vlplay()},1e3),Party.setLife())},resetStocks:function(){this.isPlaying&&($(".capsstock span").show(),Viensla.launched=0,Player.launched=0)},setLife:function(){if(this.isPlaying){var a=Math.round(Player.lives/Party.lives*100),b=Math.round(Viensla.lives/Party.lives*100);$plpart.find(".life").height(a+"%"),$vlpart.find(".life").height(b+"%"),(0>=a||0>=b)&&(Party.isPlaying=!1,console.log("PARTY OVER"),$("#party").fadeIn())}}};planeWIDTH=280,planeHEIGHT=500;var tableSurfaceDim=[100,2,20],tablefootSurfaceDim=[80,40,2],level,_floor,_tapis,_tablefoot,_table,frontLight=new THREE.DirectionalLight(16777215,.7),backLight=new THREE.DirectionalLight(16777215,.7),ambientLight=new THREE.AmbientLight(0),rightLight=new THREE.DirectionalLight(16711422,.4),leftLight=new THREE.DirectionalLight(16711422,.3),pointLight=new THREE.PointLight(16777215,.6),light1,light2,light3,light4,light5,light6,light7,light8,light9,light10,light11,light12,Player={score:0,launched:0,isPlaying:!0,totalLaunched:0,lives:0,initialize:function(){Player.lives=Party.lives,bottle_geo.buffersNeedUpdate=!0,bottle_geo.uvsNeedUpdate=!0,this.bottle=new Physijs.CylinderMesh(bottle_geo,bottle_mat,320,{friction:.1,restitution:.1}),this.bottle.scale.set(10,10,10),this.bottle.castShadow=!0,this.bottle.receiveShadow=!0,this.bottle.name="plBottle",Player.place({x:0,z:92}),Player.generateBottle()},place:function(a){this.bottle.position.y=tablefootSurfaceDim[1]+tablefootSurfaceDim[1]/2+18,this.bottle.position.x=a.x,this.bottle.position.z=a.z},generateBottle:function(){scene.add(Player.bottle),Player.generateCaps()},generateCaps:function(){var a=Physijs.createMaterial(new THREE.MeshLambertMaterial(mat_caps.materials));a.side=2,a.color.setHex(cyellow),this.bottlecaps=new Physijs.CylinderMesh(geo_caps,a,.3),this.bottlecaps.castShadow=!0,this.bottlecaps.receiveShadow=!0,this.bottlecaps.scale.set(capModelscale,capModelscale,capModelscale),this.bottlecaps.rotation.x=Math.PI,this.bottlecaps.position.y=Player.bottle.position.y+19,this.bottlecaps.position.x=Player.bottle.position.x,this.bottlecaps.position.z=Player.bottle.position.z,this.bottlecaps.name="plCap",this.bottlecaps.collided=!1,scene.add(Player.bottlecaps)}},perfectShoot=[{y:140,x:-2,pwr:30},{y:100,x:-1,pwr:80},{y:130,x:2,pwr:35},{y:180,x:-2,pwr:21}],Viensla={score:0,launched:0,totalLaunched:0,isPerfect:!1,imprecision:10,isPlaying:!1,lives:0,initialize:function(){Player.lives=Party.lives;Physijs.createMaterial(new THREE.MeshPhongMaterial({color:cgreen,specular:6710886,ambient:0,shininess:10,shading:THREE.SmoothShading,opacity:.8,transparent:!0,side:2}));this.bottle=new Physijs.CylinderMesh(bottle_geo,bottle_mat,320,{friction:.1,restitution:.1}),this.bottle.scale.set(10,10,10),this.bottle.castShadow=!0,this.bottle.receiveShadow=!0,this.bottle.name="vlBottle",Viensla.place({x:0,z:-92}),Viensla.generateBottle()},place:function(a){this.bottle.position.y=tablefootSurfaceDim[1]+tablefootSurfaceDim[1]/2+18,this.bottle.position.x=a.x,this.bottle.position.z=a.z},generateBottle:function(){scene.add(Viensla.bottle),Viensla.generateCaps()},generateCaps:function(){var a=Physijs.createMaterial(new THREE.MeshLambertMaterial(mat_caps.materials));a.side=2,a.color.setHex(cgreen),this.bottlecaps=new Physijs.CylinderMesh(geo_caps,a,.3),this.bottlecaps.castShadow=!0,this.bottlecaps.receiveShadow=!0,this.bottlecaps.scale.set(capModelscale,capModelscale,capModelscale),this.bottlecaps.rotation.x=Math.PI,this.bottlecaps.position.y=Viensla.bottle.position.y+19,this.bottlecaps.position.x=Viensla.bottle.position.x,this.bottlecaps.position.z=Viensla.bottle.position.z,this.bottlecaps.name="vlCap",this.bottlecaps.collided=!1,scene.add(Viensla.bottlecaps)},launchCaps:function(){Viensla.isPlaying=!0;var a=new THREE.Vector3,b=new THREE.Vector3,c=new THREE.Vector3,d=new THREE.Vector3,e=20*Math.random()+80,f=10*Math.random()-5,g=Math.round(3*Math.random());if(g=perfectShoot[g],globalDirection=-1,power=Math.round(g.pwr+(Math.random()-.5)*Viensla.imprecision),e=Math.round(g.y+(Math.random()-.5)*Viensla.imprecision),f=Math.round(g.x+(Math.random()-.5)*Viensla.imprecision),Viensla.isPerfect){var h=Math.round(3*Math.random());e=perfectShoot[h].y,f=perfectShoot[h].x,power=perfectShoot[h].pwr}Player.isPlaying=!1,d.set(f,e,playerDistance*globalDirection),create_caps("vl"),playedCaps.position.copy(d),playedCaps.__dirtyPosition=!0,playedCaps.floating=!1,b.set(1,1,1),c.set(10*Math.random(),10*Math.random(),20*Math.random()),playedCaps.setAngularFactor(b),playedCaps.setLinearFactor(b),a.set(1,-3,-power*strengh*globalDirection),playedCaps.setLinearVelocity(a),playedCaps.setAngularVelocity(c),playedCaps=null,Viensla.launched++,Viensla.totalLaunched++}};document.addEventListener("keydown",function(a){switch(console.log(a.keyCode),a.keyCode){case 37:break;case 39:break;case 38:break;case 40:break;case 32:break;case 67:break;case 86:console.log("bottlecaps vl"),lookatobj=BottleViensla.bottle;break;case 66:lookatobj=scene;break;case 65:axes.presence?(axes.traverse(function(a){a.visible=!1}),axes.presence=!1):(axes.traverse(function(a){a.visible=!0}),axes.presence=!0);break;case 13:change_camera()}});var Sounds;!function(){var a="assets/sounds/";Sounds={simpletap1:new Audio(a+"choc_simple_1.mp3"),simpletap2:new Audio(a+"choc_simple_2.mp3"),simpletap3:new Audio(a+"choc_simple_3.mp3"),clink:new Audio(a+"clink.mp3"),capcap:new Audio(a+"capcap.mp3"),pschit1:new Audio(a+"pschit_1.mp3"),pschit2:new Audio(a+"pschit_2.mp3"),mute:!0}}(jQuery),THREE.ShaderTypes={phongDiffuse:{uniforms:{uDirLightPos:{type:"v3",value:new THREE.Vector3},uDirLightColor:{type:"c",value:new THREE.Color(16777215)},uMaterialColor:{type:"c",value:new THREE.Color(16777215)},uKd:{type:"f",value:.7},uBorder:{type:"f",value:.4}},vertexShader:["varying vec3 vNormal;","varying vec3 vViewPosition;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","vNormal = normalize( normalMatrix * normal );","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","vViewPosition = -mvPosition.xyz;","}"].join("\n"),fragmentShader:["uniform vec3 uMaterialColor;","uniform vec3 uDirLightPos;","uniform vec3 uDirLightColor;","uniform float uKd;","uniform float uBorder;","varying vec3 vNormal;","varying vec3 vViewPosition;","void main() {","vec4 lDirection = viewMatrix * vec4( uDirLightPos, 0.0 );","vec3 lVector = normalize( lDirection.xyz );","vec3 normal = normalize( vNormal );","float diffuse = dot( normal, lVector );","if ( diffuse > 0.6 ) { diffuse = 1.0; }","else if ( diffuse > -0.2 ) { diffuse = 0.7; }","else { diffuse = 0.3; }","gl_FragColor = vec4( uKd * uMaterialColor * uDirLightColor * diffuse, 1.0 );","}"].join("\n")}};var materialColor=new THREE.Color;materialColor.setHex(16777215);var phongMaterial=createShaderMaterial("phongDiffuse",rightLight);phongMaterial.uniforms.uMaterialColor.value.copy(materialColor),phongMaterial.side=THREE.DoubleSide;