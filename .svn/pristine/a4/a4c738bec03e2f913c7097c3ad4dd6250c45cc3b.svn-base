/*! caps 30-10-2014 */
function loadCollada(){var a=new THREE.JSONLoader;a.load("models/cap_model.json",function(b,c){a.load("models/bottle_model.json",function(a,d){bottle_geo=a,console.log(bottle_geo,d[0]),bottle_mat=new THREE.MeshFaceMaterial(d),c[0].side=2;c[0];geo_caps=b,mat_caps=new THREE.MeshFaceMaterial(c),console.log(mat_caps.materials[0]),initScene()})})}function render(){BottleViensla.bottlecaps.position.y<=BottleViensla.bottle.position.y&&(BottleViensla.generateCaps(),plscore++,$plpart.find(".score").text(plscore)),BottlePlayer.bottlecaps.position.y<=BottlePlayer.bottle.position.y&&(BottlePlayer.generateCaps(),vlscore++,$vlpart.find(".score").text(vlscore)),camera.lookAt(lookatobj.position);var a=5e-4*Date.now();pointLight.position.x=3e3*Math.sin(a),pointLight.position.y=600,pointLight.position.z=3e3*Math.cos(a),renderer.render(scene,camera),requestAnimationFrame(render)}function create_caps(){var a=Math.random()>.98,b=a?4:2,c=Physijs.createMaterial(new THREE.MeshLambertMaterial(mat_caps.materials));if(c.side=2,c.color.setHex(a?cred:cblue),ball=new Physijs.CapsuleMesh(geo_caps,c,b,{friction:0,restitution:.8}),ball.scale.set(capModelscale,capModelscale,capModelscale),ball.position.y=50,ball.position.x=0,ball.position.z=playerDistance*globalDirection,ball.castShadow=!0,ball.receiveShadow=!0,scene.add(ball),elements.push(ball),playedCaps=ball,elements.length>10){var d=elements[0];scene.remove(d),elements.splice(0,1)}}function setPower(){power+=powerDir,power>100&&(powerDir=-speedbar),0>power&&(powerDir=+speedbar),$(".powerbar .bar").height(power+"%")}function create_camera(){playerCamera=new THREE.PerspectiveCamera(VIEW_ANGLE,ASPECT,NEAR,FAR),playerCamera.position.set(playerCamPos.x,playerCamPos.y,playerCamPos.z),playerCamera.lookAt(scene),scene.add(playerCamera),vlCamera=new THREE.PerspectiveCamera(VIEW_ANGLE,ASPECT,NEAR,FAR),vlCamera.position.set(vlCamPos.x,vlCamPos.y,vlCamPos.z),vlCamera.lookAt(scene),scene.add(vlCamera),camera=playerCamera,camera.initialpos=playerCamPos,mouse={x:0,y:0},document.addEventListener("mousemove",function(a){mouse.x=a.clientX/window.innerWidth-.5,mouse.y=a.clientY/window.innerHeight-.5,camera.position.x+=1.5*(20*mouse.x-camera.position.x)+camera.initialpos.x,camera.position.y+=1.5*(10*mouse.y-camera.position.y)+camera.initialpos.y-10,camera.lookAt(lookatobj)},!1)}function change_camera(){camera==playerCamera?(camera=vlCamera,camera.initialpos=vlCamPos,lookatobj=BottlePlayer.bottle,globalDirection=-1):(camera=playerCamera,camera.initialpos=playerCamPos,lookatobj=BottleViensla.bottle,globalDirection=1)}function buildAxes(a){var b=new THREE.Object3D;return b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(a,0,0),16711680,!1)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(-a,0,0),16711680,!0)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,a,0),65280,!1)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,-a,0),65280,!0)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,a),255,!1)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,-a),255,!0)),b}function buildAxis(a,b,c,d){var e,f=new THREE.Geometry;e=d?new THREE.LineDashedMaterial({linewidth:3,color:c,dashSize:3,gapSize:3}):new THREE.LineBasicMaterial({linewidth:3,color:c}),f.vertices.push(a.clone()),f.vertices.push(b.clone()),f.computeLineDistances();var g=new THREE.Line(f,e,THREE.LinePieces);return g}function change_player(){}function create_table(){level=new Physijs.BoxMesh(new THREE.CubeGeometry(5,1,.5),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:cblue})),0),level.position.x=0,level.position.y=0,level.position.z=0,level.castShadow=!0,level.receiveShadow=!0,_floor=new Physijs.BoxMesh(new THREE.CubeGeometry(planeWIDTH,planeHEIGHT,35),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:cred})),0),_floor.rotation.x=Math.PI/2,_floor.position.x=0,_floor.position.y=1,_floor.position.z=0,_floor.castShadow=!0,_floor.receiveShadow=!0,level.add(_floor),_tablefoot=new Physijs.BoxMesh(new THREE.CubeGeometry(tablefootSurfaceDim[0],tablefootSurfaceDim[1],tablefootSurfaceDim[2]),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:cblue})),0),_tablefoot.position.x=0,_tablefoot.position.y=tablefootSurfaceDim[1],_tablefoot.position.z=-90,_tablefoot.castShadow=!0,_tablefoot.receiveShadow=!0,level.add(_tablefoot),_tablefoot=new Physijs.BoxMesh(new THREE.CubeGeometry(tablefootSurfaceDim[0],tablefootSurfaceDim[1],tablefootSurfaceDim[2]),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:cgreen})),0),_tablefoot.position.x=0,_tablefoot.position.y=tablefootSurfaceDim[1],_tablefoot.position.z=90,_tablefoot.castShadow=!0,_tablefoot.receiveShadow=!0,level.add(_tablefoot),_table=new Physijs.BoxMesh(new THREE.CubeGeometry(tableSurfaceDim[0],tableSurfaceDim[1],tableSurfaceDim[2]),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:16777215})),0),_table.position.x=0,_table.position.y=tablefootSurfaceDim[1]+tablefootSurfaceDim[1]/2,_table.position.z=-90,_table.castShadow=!0,_table.receiveShadow=!0,level.add(_table),_table=new Physijs.BoxMesh(new THREE.CubeGeometry(tableSurfaceDim[0],tableSurfaceDim[1],tableSurfaceDim[2]),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:16777215})),0),_table.position.x=0,_table.position.y=tablefootSurfaceDim[1]+tablefootSurfaceDim[1]/2,_table.position.z=90,_table.castShadow=!0,_table.receiveShadow=!0,level.add(_table),scene.add(level);var a=document.getElementById("vertexShader").textContent,b=document.getElementById("fragmentShader").textContent,c={topColor:{type:"c",value:new THREE.Color(30719)},bottomColor:{type:"c",value:new THREE.Color(16777215)},offset:{type:"f",value:33},exponent:{type:"f",value:.6}};c.topColor.value.copy(hemiLight.color),scene.fog.color.copy(c.bottomColor.value);var d=new THREE.SphereGeometry(4e3,32,15),e=new THREE.ShaderMaterial({vertexShader:a,fragmentShader:b,uniforms:c,side:THREE.BackSide}),f=new THREE.Mesh(d,e);scene.add(f)}function create_lights(){var a=new THREE.DirectionalLight(16777215,.7);a.castShadow=!0,a.shadowDarkness=.1,a.shadowBias=-1e-4,a.shadowCameraNear=1,a.shadowMapWidth=2048,a.shadowMapHeight=2048,a.shadowCameraLeft=planeWIDTH/2,a.shadowCameraTop=-planeHEIGHT/2,a.shadowCameraRight=-planeWIDTH/2,a.shadowCameraBottom=planeHEIGHT/2,a.position.set(0,100,80),scene.add(a);var b=new THREE.DirectionalLight(16777215,.7);b.castShadow=!0,b.shadowDarkness=.1,b.shadowBias=-1e-4,b.shadowCameraNear=1,b.shadowMapWidth=2048,b.shadowMapHeight=2048,b.shadowCameraLeft=planeWIDTH/2,b.shadowCameraTop=-planeHEIGHT/2,b.shadowCameraRight=-planeWIDTH/2,b.shadowCameraBottom=planeHEIGHT/2,b.position.set(0,100,-80),scene.add(b);var c=new THREE.DirectionalLight(16711422,.1);c.castShadow=!0,c.shadowDarkness=.05,c.shadowBias=-1e-4,c.shadowCameraNear=1,c.shadowMapWidth=2048,c.shadowMapHeight=2048,c.shadowCameraLeft=planeWIDTH/2,c.shadowCameraTop=-planeHEIGHT/2,c.shadowCameraRight=-planeWIDTH/2,c.shadowCameraBottom=planeHEIGHT/2,c.position.set(80,40,30);var d=new THREE.DirectionalLight(16711422,.1);d.castShadow=!0,d.shadowDarkness=.05,d.shadowBias=-1e-4,d.shadowCameraNear=1,d.shadowMapWidth=2048,d.shadowMapHeight=2048,d.shadowCameraLeft=planeWIDTH/2,d.shadowCameraTop=-planeHEIGHT/2,d.shadowCameraRight=-planeWIDTH/2,d.shadowCameraBottom=planeHEIGHT/2,d.position.set(-100,70,-10),scene.add(new THREE.AmbientLight(0)),pointLight=new THREE.PointLight(16777215,.6),scene.add(pointLight),hemiLight=new THREE.HemisphereLight(16777215,16777215,.6),hemiLight.color.setHSL(.6,1,.6),hemiLight.groundColor.setHSL(.095,1,.75),hemiLight.position.set(0,500,0),scene.add(hemiLight)}function addFloatingLights(){var a=new THREE.SphereGeometry(.5,16,8);light1=new THREE.PointLight(16711744,2,50),light1.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16711744}))),scene.add(light1),light2=new THREE.PointLight(16639,2,50),light2.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16639}))),scene.add(light2),light3=new THREE.PointLight(8454016,2,50),light3.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:8454016}))),scene.add(light3),light4=new THREE.PointLight(16755200,2,50),light4.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16755200}))),scene.add(light4),light5=new THREE.PointLight(16711744,2,50),light5.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16711744}))),scene.add(light5),light6=new THREE.PointLight(16639,2,50),light6.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16639}))),scene.add(light6),light7=new THREE.PointLight(8454016,2,50),light7.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:8454016}))),scene.add(light7),light8=new THREE.PointLight(16755200,2,50),light8.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16755200}))),scene.add(light8),light9=new THREE.PointLight(16711744,2,50),light9.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16711744}))),scene.add(light9),light10=new THREE.PointLight(16639,2,50),light10.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16639}))),scene.add(light10),light11=new THREE.PointLight(8454016,2,50),light11.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:8454016}))),scene.add(light11),light12=new THREE.PointLight(16755200,2,50),light12.add(new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:16755200}))),scene.add(light12)}function animateFloatingLights(a){light1.position.x=50*Math.sin(.7*a),light1.position.y=50*Math.cos(.5*a)+100,light1.position.z=50*Math.cos(.3*a),light2.position.x=50*Math.cos(.3*a),light2.position.y=50*Math.sin(.5*a)+100,light2.position.z=50*Math.sin(.7*a),light3.position.x=50*Math.sin(.7*a),light3.position.y=50*Math.cos(.3*a)+100,light3.position.z=50*Math.sin(.5*a),light4.position.x=50*Math.sin(.3*a),light4.position.y=50*Math.cos(.7*a)+100,light4.position.z=50*Math.sin(.5*a),light5.position.x=50*Math.sin(.3*a),light5.position.y=50*Math.cos(.7*a)+100,light5.position.z=50*Math.sin(.5*a),light6.position.x=50*Math.sin(.3*a),light6.position.y=50*Math.cos(.7*a)+100,light6.position.z=50*Math.sin(.5*a),light7.position.x=50*Math.sin(.3*a),light7.position.y=50*Math.cos(.7*a)+100,light7.position.z=50*Math.sin(.5*a),light8.position.x=50*Math.sin(.3*a),light8.position.y=50*Math.cos(.7*a)+100,light8.position.z=50*Math.sin(.5*a),light9.position.x=50*Math.sin(.3*a),light9.position.y=50*Math.cos(.7*a)+100,light9.position.z=50*Math.sin(.5*a),light10.position.x=50*Math.sin(.3*a),light10.position.y=50*Math.cos(.7*a)+100,light10.position.z=50*Math.sin(.5*a),light11.position.x=50*Math.sin(.3*a),light11.position.y=50*Math.cos(.7*a)+100,light11.position.z=50*Math.sin(.5*a),light12.position.x=50*Math.sin(.3*a),light12.position.y=50*Math.cos(.7*a)+100,light12.position.z=50*Math.sin(.5*a)}var cblue=6793921,cyellow=16241731,cgreen=7908704,cred=12674922,container,scene,renderer,light,ball,plane,bottle,bottlecaps,axes,initEventHandling,initScene,WIDTH,HEIGHT,planeWIDTH,planeHEIGHT,elements=[],playedCaps=null,mouse_position=new THREE.Vector3,block_offset=new THREE.Vector3,_i,_v3=new THREE.Vector3,intersect_plane,lookatobj,pilone,mouse,mouse3D=new THREE.Vector3,_nullVector=new THREE.Vector3(0,0,0),DCMP=new THREE.Vector3(0,0,0),onRenderFcts=[],lastTimeMsec=null,capsYpos=80,movingCaps=null,clock=new THREE.Clock,dir,distance,holdingDown=!1;Physijs.scripts.worker="/js/physijs/physijs_worker.js",Physijs.scripts.ammo="ammo.js",container=document.querySelector(".viewport"),WIDTH=window.innerWidth,HEIGHT=window.innerHeight;var playerDistance=85,globalDirection=1,capsDae,capsMesh,capModelscale=1.5,geo_caps,mat_caps,bottle_geo,bottle_mat,$plpart,$vlpart,plscore=0,vlscore=0,table_material=Physijs.createMaterial(new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("images/wood.jpg"),ambient:16777215,opacity:1,transparent:!0}),.9,.2);table_material.map.wrapS=table_material.map.wrapT=THREE.RepeatWrapping,table_material.map.repeat.set(5,5);var chimey_material=Physijs.createMaterial(new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("images/caps1.jpg"),ambient:16777215,opacity:1,transparent:!0}),.9,.2);chimey_material.map.wrapS=chimey_material.map.wrapT=THREE.RepeatWrapping,chimey_material.map.repeat.set(5,5);var caps_test_geometry,caps_geometry;caps_geometry=new THREE.CylinderGeometry(4,3,1.2,32);var caps_material=Physijs.createMaterial(new THREE.MeshLambertMaterial({color:cred}),.4,.8),bottlecaps_material=Physijs.createMaterial(new THREE.MeshLambertMaterial({color:cgreen}),.4,.8),initScene=function(){$plpart=$(".pl-part"),$vlpart=$(".vl-part"),scene=new Physijs.Scene,scene.setGravity(new THREE.Vector3(0,-80,0)),scene.fog=new THREE.Fog(328965,2e3,3500),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setSize(WIDTH,HEIGHT),renderer.shadowMapEnabled=!0,renderer.shadowMapSoft=!0,renderer.shadowMapType=THREE.PCFShadowMap,renderer.shadowMapAutoUpdate=!0,renderer.gammaInput=!0,renderer.gammaOutput=!0,renderer.setClearColor(scene.fog.color,1),container.appendChild(renderer.domElement),create_camera(),create_lights(),create_table(),axes=buildAxes(1e3),axes.presence=!1,axes.traverse(function(a){a.visible=!1}),scene.add(axes),BottleViensla.initialize(),BottlePlayer.initialize(),create_caps(),lookatobj=BottleViensla.bottle,scene.simulate(),initEventHandling(),render(),scene.addEventListener("update",function(){playedCaps&&playedCaps.position.copy(DCMP),holdingDown&&setPower(),scene.simulate(void 0,2)})};initEventHandling=function(){var a,b,c,d=new THREE.Vector3,e=new THREE.Vector3,f=new THREE.Vector3;return a=function(){playedCaps&&(holdingDown=!0,d.set(1,-3,-100),power=0,$(".powerbar").fadeIn())},b=function(a){var b=a.clientX,c=a.clientY;$(".powerbar").css({left:b+50,top:c-50}),playedCaps&&(mouse3D.set(b/window.innerWidth*2-1,2*-(c/window.innerHeight)+1,1),mouse3D.unproject(camera),dir=mouse3D.sub(camera.position).normalize(),distance=-camera.position.z/dir.z,DCMP=camera.position.clone().add(dir.multiplyScalar(distance/2)),DCMP.z=playerDistance*globalDirection)},c=function(){playedCaps&&(holdingDown=!1,playedCaps.__dirtyPosition=!0,e.set(1,1,1),f.set(Math.random(),10*Math.random(),20*Math.random()),playedCaps.setAngularFactor(e),playedCaps.setLinearFactor(e),d.set(1,-3,-power*strengh*globalDirection),playedCaps.setLinearVelocity(d),playedCaps.setAngularVelocity(f),playedCaps.position.copy(DCMP),playedCaps=null,power=0,$(".powerbar").fadeOut(),setTimeout(function(){change_camera(),create_caps()},2e3))},function(){renderer.domElement.addEventListener("mousedown",a),renderer.domElement.addEventListener("mousemove",b),renderer.domElement.addEventListener("mouseup",c)}}();var power=0,speedbar=2,powerDir=speedbar,strengh=6;$(document).ready(function(){loadCollada()});var playerCamera,vlCamera,camera,playerCamPos=new THREE.Vector3(10,190,170),vlCamPos=new THREE.Vector3(10,190,-170),VIEW_ANGLE=75,ASPECT=WIDTH/HEIGHT,NEAR=.1,FAR=1e4,BottleViensla={initialize:function(){var a=Physijs.createMaterial(new THREE.MeshPhongMaterial({color:cgreen,specular:6710886,ambient:0,shininess:10,shading:THREE.SmoothShading,opacity:.8,transparent:!0,side:2}));console.log(a),this.bottle=new Physijs.CylinderMesh(bottle_geo,a,320,{friction:.1,restitution:.1}),this.bottle.scale.set(10,10,10),this.bottle.castShadow=!0,this.bottle.receiveShadow=!0,BottleViensla.place({x:0,z:-92}),BottleViensla.generateBottle()},place:function(a){this.bottle.position.y=tablefootSurfaceDim[1]+tablefootSurfaceDim[1]/2+18,this.bottle.position.x=a.x,this.bottle.position.z=a.z},generateBottle:function(){scene.add(BottleViensla.bottle),BottleViensla.generateCaps()},generateCaps:function(){var a=Physijs.createMaterial(new THREE.MeshLambertMaterial(mat_caps.materials));a.side=2,a.color.setHex(cgreen),this.bottlecaps=new Physijs.CylinderMesh(geo_caps,a,.3),this.bottlecaps.castShadow=!0,this.bottlecaps.receiveShadow=!0,this.bottlecaps.scale.set(capModelscale,capModelscale,capModelscale),this.bottlecaps.rotation.x=Math.PI,this.bottlecaps.position.y=BottleViensla.bottle.position.y+19,this.bottlecaps.position.x=BottleViensla.bottle.position.x,this.bottlecaps.position.z=BottleViensla.bottle.position.z,scene.add(BottleViensla.bottlecaps)}},BottlePlayer={initialize:function(){var a=Physijs.createMaterial(new THREE.MeshPhongMaterial({color:cyellow,specular:6710886,ambient:0,shininess:10,shading:THREE.SmoothShading,opacity:.8,transparent:!0,side:2}));this.bottle=new Physijs.CylinderMesh(bottle_geo,a,320,{friction:.1,restitution:.1}),this.bottle.scale.set(10,10,10),this.bottle.castShadow=!0,this.bottle.receiveShadow=!0,BottlePlayer.place({x:0,z:92}),BottlePlayer.generateBottle()},place:function(a){this.bottle.position.y=tablefootSurfaceDim[1]+tablefootSurfaceDim[1]/2+18,this.bottle.position.x=a.x,this.bottle.position.z=a.z},generateBottle:function(){scene.add(BottlePlayer.bottle),BottlePlayer.generateCaps()},generateCaps:function(){var a=Physijs.createMaterial(new THREE.MeshLambertMaterial(mat_caps.materials));a.side=2,a.color.setHex(cyellow),this.bottlecaps=new Physijs.CylinderMesh(geo_caps,a,.3),this.bottlecaps.castShadow=!0,this.bottlecaps.receiveShadow=!0,this.bottlecaps.scale.set(capModelscale,capModelscale,capModelscale),this.bottlecaps.rotation.x=Math.PI,this.bottlecaps.position.y=BottlePlayer.bottle.position.y+19,this.bottlecaps.position.x=BottlePlayer.bottle.position.x,this.bottlecaps.position.z=BottlePlayer.bottle.position.z,scene.add(BottlePlayer.bottlecaps)}};document.addEventListener("keydown",function(a){switch(console.log(a.keyCode),a.keyCode){case 37:break;case 39:break;case 38:break;case 40:break;case 32:create_caps();break;case 67:break;case 86:console.log("bottlecaps vl"),lookatobj=BottleViensla.bottle;break;case 66:lookatobj=scene;break;case 65:axes.presence?(axes.traverse(function(a){a.visible=!1}),axes.presence=!1):(axes.traverse(function(a){a.visible=!0}),axes.presence=!0);break;case 13:change_camera()}});var currentPlayer="player";planeWIDTH=280,planeHEIGHT=500;var tableSurfaceDim=[100,2,20],tablefootSurfaceDim=[80,40,2],level,_floor,_tablefoot,_table,pointLight,light1,light2,light3,light4,light5,light6,light7,light8,light9,light10,light11,light12;