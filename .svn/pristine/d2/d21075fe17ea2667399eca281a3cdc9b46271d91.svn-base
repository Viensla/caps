var timeoutRobot;

var Party = {
    isPlaying : false,
    capsPerTurn : 3,
    lives : 100,
    create : function(){
        Viensla.score = Player.score = Viensla.launched = Player.launched = 0;
        Viensla.lives = Player.lives = Party.lives;

        Party.isPlaying = true;

        Party.setLife();


//        Party.plplay();

        Viensla.isPlaying = false;
        Player.isPlaying = true;


        $('#start-screen').fadeOut();

        $('.capsstock').fadeIn();

        $('#black_filter').fadeOut();

        Player.generateCaps();


    },
    vlplay : function(){

        if(this.isPlaying){
            if(Viensla.launched < Party.capsPerTurn && !Player.isPlaying){

                $vlpart.find('.capsstock span').eq(Viensla.launched).removeClass().addClass('animated zoomOut');

                Viensla.isPlaying = true;
                Player.isPlaying = false;
                Viensla.launchCaps();
                Viensla.launched++;
                Viensla.totalLaunched++;

                if(Viensla.launched < Party.capsPerTurn){
                    timeoutRobot = setTimeout(function(){

                        Party.vlplay();

                    }, 3000);
                }else{
                    Player.isPlaying = true;
                    Player.launched = 0;
                    Viensla.isPlaying = false;
                    console.log('Viens la no more caps !');
                    this.resetStocks();
                }



            }else{
                Player.isPlaying = true;
                Player.launched = 0;
                Viensla.isPlaying = false;
                console.log('Viens la no more caps !');
                $('#turn-m p').text('Your turn!');
                turnm();
//                this.resetStocks();
            }
        }




    },
    plplay : function(){
        if(this.isPlaying){
            if(Player.launched < Party.capsPerTurn && !Viensla.isPlaying){
                globalDirection = 1;
                create_caps('pl');


                Player.isPlaying = true;
                Viensla.isPlaying = false;


            }else{

                Player.isPlaying = false;

                console.log('Player no more caps !');

                Viensla.launched = 0;
                this.resetStocks();

                $('#turn-m p').text('Vienslà\'s turn!');
                turnm();

                Party.vlplay();

            }
        }
    },

    vlcaps : function(){
        if(this.isPlaying){
            Viensla.isPlaying = false;
            Player.isPlaying = true;


            Viensla.score++;

            Player.drunked += 2;

            Player.lives -= Math.round((10 + 6 - Viensla.launched*2));

            capsm();

            setTimeout(function(){
                $('#turn-m p').text('Your turn!');
                turnm();
            },1000);


            setTimeout(function(){
                Party.resetStocks();
                Player.generateCaps();
            }, 2000);
            Party.setLife();

        }
    },


    plcaps : function(){
        if(this.isPlaying){
            Player.score++;
            Viensla.lives -= Math.round((10 + 6 - Player.launched*2));

            Player.isPlaying = false;

            capsm();

            setTimeout(function(){
                $('#turn-m p').text('Vienslà\'s turn!');
                turnm();
            },1000);

            setTimeout(function(){
                Party.resetStocks();
                Viensla.generateCaps();
                Party.vlplay();
            }, 2000);

            Party.setLife();
        }

    },

    resetStocks : function(){
        if(this.isPlaying){
            console.log('stock reseted');

            $('.capsstock span.zoomOut').removeClass('zoomOut').addClass('zoomIn');

            Viensla.launched = 0;

            Player.launched = 0;


        }

        if(Player.drunked > 11){
            Player.drunked -= 2;
        }
    },

    setLife : function(){
        if(this.isPlaying){
            var pctPlLife = Math.round(Player.lives / Party.lives * 100);
            var pctVlLife = Math.round(Viensla.lives / Party.lives * 100);

            $plpart.find('.life').height(pctPlLife+"%");
            $vlpart.find('.life').height(pctVlLife+"%");

            if(pctPlLife <= 0 || pctVlLife <= 0){
                Party.isPlaying = false;
                console.log('PARTY OVER');

                if(pctPlLife <= 0){
                    $('#winner-m p').text('Vienslà wins !')
                }else if(pctVlLife <= 0){
                    $('#winner-m p').text('You win !')
                }

                winnerm();

                $('#black_filter').fadeIn();
                $('#start-screen').fadeIn();
            }
        }
    }
}



var animend ='webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend';
function capsm(){
    $('#caps-m').show().removeClass().addClass('animated tada').one(animend, function(){
        $(this).removeClass().addClass('animated zoomOut');
    });
    if(!Sounds.mute) Sounds.pschit2.play();
}

function turnm(){

    if($('#turn-m').hasClass('bounceOutRight') || $('#turn-m').hasClass('bounceInLeft') ) return;

    $('#turn-m').removeClass().addClass('animated bounceInLeft').show().one(animend, function(){
        $(this).removeClass().addClass('animated bounceOutRight').one(animend, function(){
            $(this).removeClass().hide();
        });
    });
    if(!Sounds.mute) Sounds.pschit2.play();
}


function winnerm(){
    $('#winner-m').removeClass().addClass('animated bounceInLeft').show().one(animend, function(){
        $(this).removeClass().addClass('animated bounceOutRight');
    });
    if(!Sounds.mute) Sounds.pschit2.play();
}