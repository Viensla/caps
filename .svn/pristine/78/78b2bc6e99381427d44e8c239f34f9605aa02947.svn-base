/*! caps 28-10-2014 */
function render(){bottlecaps.position.y<=bottle.position.y&&create_bottlecaps(),camera.lookAt(lookatobj.position),renderer.render(scene,camera),requestAnimationFrame(render)}function create_caps(){if(ball=new Physijs.CylinderMesh(caps_geometry,caps_material,20,{friction:0,restitution:.8}),ball.rotation.x=Math.PI,ball.position.y=50,ball.position.x=0,ball.position.z=playerDistance,ball.castShadow=!0,ball.receiveShadow=!0,scene.add(ball),elements.push(ball),playedCaps=ball,elements.length>10){var a=elements[0];scene.remove(a),elements.splice(0,1)}}function setPower(){power+=powerDir,power>250&&(powerDir=-3),50>power&&(powerDir=3),$(".powerbar").width(power/2.5+"%")}function create_camera(){camera=new THREE.PerspectiveCamera(VIEW_ANGLE,ASPECT,NEAR,FAR);var a=30,b=80;camera.position.set(a,b,90),camera.lookAt(scene),scene.add(camera),mouse={x:0,y:0},document.addEventListener("mousemove",function(c){mouse.x=c.clientX/window.innerWidth-.5,mouse.y=c.clientY/window.innerHeight-.5,camera.position.x+=1.5*(10*mouse.x-camera.position.x)+a,camera.position.y+=.2*(5*mouse.y-camera.position.y)*3+b,camera.lookAt(lookatobj)},!1)}function create_lights(){var a=new THREE.AmbientLight(131586);scene.add(a);var b=new THREE.DirectionalLight(16777215);b.position.set(0,100,60),b.castShadow=!0,b.shadowDarkness=.3,b.shadowBias=-1e-4,b.shadowCameraNear=1,b.shadowMapWidth=2048,b.shadowMapHeight=2048,b.shadowCameraLeft=planeWIDTH/2,b.shadowCameraTop=-planeHEIGHT/2,b.shadowCameraRight=-planeWIDTH/2,b.shadowCameraBottom=planeHEIGHT/2,scene.add(b);var c=new THREE.DirectionalLight("white",.75);c.position.set(0,-100,-60),scene.add(c)}function create_plane(){plane=new Physijs.BoxMesh(new THREE.CubeGeometry(planeWIDTH,planeHEIGHT,35),table_material,0,{restitution:.2,friction:.8}),plane.rotation.x=Math.PI/2,plane.position.y=-.5,plane.receiveShadow=!0,scene.add(plane)}function create_bottle(a){bottle=new Physijs.CylinderMesh(new THREE.CylinderGeometry(3,5,30,32),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:16777215}),.4,.8),0),bottle.position.y=32,bottle.position.x=a,bottle.position.z=-80,bottle.castShadow=!0,bottle.receiveShadow=!0,scene.add(bottle),lookatobj=bottle,create_bottlecaps()}function create_bottlecaps(){bottlecaps=new Physijs.CylinderMesh(caps_geometry,bottlecaps_material,.3),bottlecaps.position.y=bottle.position.y+16,bottlecaps.position.x=bottle.position.x,bottlecaps.position.z=bottle.position.z,bottlecaps.castShadow=!0,bottlecaps.receiveShadow=!0,scene.add(bottlecaps)}function create_pilone(){pilone=new Physijs.BoxMesh(new THREE.BoxGeometry(3,3,2,100,100),Physijs.createMaterial(new THREE.MeshLambertMaterial({color:15658734,transparent:!0,opacity:.3}),.4,.8),0),pilone.position.y=ball.position.y-1,pilone.position.z=ball.position.z,pilone.rotation.x=Math.PI/-2,scene.add(pilone)}function buildAxes(a){var b=new THREE.Object3D;return b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(a,0,0),16711680,!1)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(-a,0,0),16711680,!0)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,a,0),65280,!1)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,-a,0),65280,!0)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,a),255,!1)),b.add(buildAxis(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,-a),255,!0)),b}function buildAxis(a,b,c,d){var e,f=new THREE.Geometry;e=d?new THREE.LineDashedMaterial({linewidth:3,color:c,dashSize:3,gapSize:3}):new THREE.LineBasicMaterial({linewidth:3,color:c}),f.vertices.push(a.clone()),f.vertices.push(b.clone()),f.computeLineDistances();var g=new THREE.Line(f,e,THREE.LinePieces);return g}var container,scene,renderer,camera,light,ball,plane,bottle,bottlecaps,axes,initEventHandling,initScene,WIDTH,HEIGHT,VIEW_ANGLE,ASPECT,NEAR,FAR,planeWIDTH,planeHEIGHT,elements=[],playedCaps=null,mouse_position=new THREE.Vector3,block_offset=new THREE.Vector3,_i,_v3=new THREE.Vector3,intersect_plane,lookatobj,pilone,mouse,mouse3D=new THREE.Vector3,_nullVector=new THREE.Vector3(0,0,0),DCMP=new THREE.Vector3(0,0,0),onRenderFcts=[],lastTimeMsec=null,capsYpos=30,movingCaps=null,clock=new THREE.Clock,dir,distance,holdingDown=!1;Physijs.scripts.worker="/js/physijs/physijs_worker.js",Physijs.scripts.ammo="ammo.js",container=document.querySelector(".viewport"),WIDTH=window.innerWidth,HEIGHT=window.innerHeight,VIEW_ANGLE=75,ASPECT=WIDTH/HEIGHT,NEAR=.1,FAR=1e4,planeWIDTH=300,planeHEIGHT=300;var playerDistance=40,y_launcher=0,y_launcher_inc=.2,table_material=Physijs.createMaterial(new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("images/wood.jpg"),ambient:16777215,opacity:.5,transparent:!0}),.9,.2);table_material.map.wrapS=table_material.map.wrapT=THREE.RepeatWrapping,table_material.map.repeat.set(5,5);var caps_geometry=new THREE.CylinderGeometry(4,3,1.2,32),caps_material=Physijs.createMaterial(new THREE.MeshLambertMaterial({color:16711680}),.4,.8),bottlecaps_material=Physijs.createMaterial(new THREE.MeshLambertMaterial({color:65280}),.4,.8),maxicaps_material="";initScene=function(){scene=new Physijs.Scene,scene.setGravity(new THREE.Vector3(0,-80,0)),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setSize(WIDTH,HEIGHT),renderer.shadowMapEnabled=!0,renderer.shadowMapSoft=!0,renderer.shadowMapType=THREE.PCFShadowMap,renderer.shadowMapAutoUpdate=!0,container.appendChild(renderer.domElement),create_camera(),create_lights(),create_plane(),axes=buildAxes(1e3),axes.presence=!1,axes.traverse(function(a){a.visible=!1}),scene.add(axes),create_bottle(0),create_caps(),scene.simulate(),render(),initEventHandling(),scene.addEventListener("update",function(){playedCaps&&playedCaps.position.copy(DCMP),holdingDown&&(setPower(),console.log(power)),scene.simulate(void 0,2)})},initEventHandling=function(){var a,b,c,d=new THREE.Vector3,e=new THREE.Vector3;return a=function(){playedCaps&&(holdingDown=!0,d.set(1,-3,-100),power=0)},b=function(a){holdingDown||(mouse3D.set(a.clientX/window.innerWidth*2-1,2*-(a.clientY/window.innerHeight)+1,1),mouse3D.unproject(camera),dir=mouse3D.sub(camera.position).normalize(),distance=-camera.position.z/dir.z,DCMP=camera.position.clone().add(dir.multiplyScalar(distance/2)),DCMP.z=playerDistance)},c=function(){playedCaps&&(holdingDown=!1,playedCaps.__dirtyPosition=!0,e.set(1,1,1),playedCaps.setAngularFactor(e),playedCaps.setLinearFactor(e),d.set(1,-3,-power),playedCaps.setLinearVelocity(d),playedCaps.position.copy(DCMP),playedCaps=null)},function(){renderer.domElement.addEventListener("mousedown",a),renderer.domElement.addEventListener("mousemove",b),renderer.domElement.addEventListener("mouseup",c)}}(),$(document).ready(function(){initScene()});var power=0,powerDir=1;document.addEventListener("keydown",function(a){switch(console.log(a.keyCode),a.keyCode){case 37:break;case 39:break;case 38:capsYpos++,ball.position.y=capsYpos,pilone.position.y=capsYpos-1;break;case 40:capsYpos--,ball.position.y=capsYpos,pilone.position.y=capsYpos-1;break;case 32:create_caps();break;case 67:lookatobj=ball;break;case 86:lookatobj=bottlecaps;break;case 66:lookatobj=scene;break;case 65:axes.presence?(axes.traverse(function(a){a.visible=!1}),axes.presence=!1):(axes.traverse(function(a){a.visible=!0}),axes.presence=!0)}});